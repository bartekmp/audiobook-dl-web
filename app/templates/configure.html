{% extends "base.html" %}

{% block title %}audiobook-dl-web - Configure Services{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <h2 class="mb-4"><i class="bi bi-gear"></i> Configure Services</h2>

        {% if request.query_params.get('success') %}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle"></i> Configuration saved successfully!
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}

        <div class="row">
            <!-- Service Selection -->
            <div class="col-md-4 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Select Service</h5>
                    </div>
                    <div class="list-group list-group-flush">
                        {% for service_id, service_info in services.items() %}
                        <a href="/configure?service={{ service_id }}"
                            class="list-group-item list-group-item-action {% if selected_service and selected_service.id == service_id %}active{% endif %}">
                            {% if service_id in configured_services %}
                            <i class="bi bi-check-circle-fill text-success"></i>
                            {% else %}
                            <i class="bi bi-circle"></i>
                            {% endif %}
                            {{ service_info.name }}
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Configuration Form -->
            <div class="col-md-8">
                {% if selected_service %}
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Configure {{ selected_service.name }}</h5>
                    </div>
                    <div class="card-body">
                        {% if selected_service.requires_shelf %}
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i>
                            <strong>Important:</strong> For {{ selected_service.name }}, you must add books to your
                            account's shelf/library before downloading them.
                        </div>
                        {% endif %}

                        <form method="post" action="/configure/{{ selected_service.id }}">
                            {% if 'login' in selected_service.auth_methods %}
                            {% if 'username' in selected_service.login_fields %}
                            <div class="mb-3">
                                <label for="username" class="form-label">Username / Email</label>
                                <input type="text" class="form-control" id="username" name="username"
                                    value="{{ current_config.username if current_config else '' }}" required>
                            </div>
                            {% endif %}

                            {% if 'password' in selected_service.login_fields %}
                            <div class="mb-3">
                                <label for="password" class="form-label">Password</label>
                                <input type="password" class="form-control" id="password" name="password"
                                    value="{{ current_config.password if current_config else '' }}" required>
                                <div class="form-text">Your password will be stored securely in the configuration file.
                                </div>
                            </div>
                            {% endif %}

                            {% if 'library' in selected_service.login_fields %}
                            <div class="mb-3">
                                <label for="library" class="form-label">Library ID</label>
                                <input type="text" class="form-control" id="library" name="library"
                                    value="{{ current_config.library if current_config else '' }}">
                                <div class="form-text">Optional: Required for some services</div>
                            </div>
                            {% endif %}
                            {% endif %}

                            {% if 'cookies' in selected_service.auth_methods %}
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i>
                                <strong>Cookie Authentication:</strong> {{ selected_service.name }} supports
                                authentication via cookies.
                                Export your browser cookies to a Netscape format file and place it as
                                <code>cookies.txt</code> in the config directory,
                                or specify the path in the configuration file manually.
                            </div>
                            {% endif %}

                            <div class="mb-3">
                                <label class="form-label">Example URL Format</label>
                                <input type="text" class="form-control" readonly
                                    value="{{ selected_service.example_url }}">
                                <div class="form-text">Use URLs like this when downloading audiobooks</div>
                            </div>

                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-save"></i> Save Configuration
                                </button>

                                {% if selected_service.id in configured_services %}
                                <button type="button" class="btn btn-danger" data-bs-toggle="modal"
                                    data-bs-target="#deleteModal">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                                {% endif %}
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Delete Confirmation Modal -->
                {% if selected_service.id in configured_services %}
                <div class="modal fade" id="deleteModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Confirm Delete</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                Are you sure you want to delete the configuration for {{ selected_service.name }}?
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <form method="post" action="/configure/{{ selected_service.id }}/delete"
                                    style="display: inline;">
                                    <button type="submit" class="btn btn-danger">Delete</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% else %}
                <div class="card">
                    <div class="card-body text-center py-5">
                        <i class="bi bi-arrow-left display-1 text-muted"></i>
                        <p class="lead mt-3">Select a service from the list to configure it</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}